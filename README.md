# URL Shortener - .NET 10 Learning Project

## Project Overview

**URL Shortener** is an application for creating and resolving abbreviated URLs, designed as a **learning project** to explore modern technologies in the .NET ecosystem through hands-on development.

### Primary Objective

Learn and incrementally integrate new technologies through building a real application, progressing from foundational concepts through deployment and observability.

### Technology Stack

| Component | Technology | Version | Notes |
|-----------|-----------|---------|-------|
| **Architecture** | Vertical Slice Architecture | - | One feature per endpoint |
| **Framework** | .NET | 10 | Minimal APIs |
| **Database** | SQL Server | 2022+ | Express or LocalDB |
| **ORM** | Entity Framework Core | 10.x | Direct access, no repository pattern |
| **API Pattern** | REPR | - | Request-Endpoint-Response |
| **Cache** | Redis | 7.x+ | - |
| **Validation** | DataAnnotations | Built-in | Native .NET attributes |
| **Logging** | Serilog | 8.x+ | Structured logging |
| **Tracing** | OpenTelemetry | 1.x+ | Distributed tracing + Aspire Dashboard |
| **Containerization** | Docker | - | Multi-stage builds |
| **Orchestration** | Docker Compose | - | Local environment |
| **Testing** | xUnit | - | Unit & Integration tests |
| **Mocking** | Moq | - | Test doubles |

### General Features

- **Well-Structured**: Vertical Slice for clean separation of concerns.
- **Async-First**: Async/await where sensible (DB, cache, logging).
- **Lean**: Two endpoints only, focus on quality over quantity.
- **Observable**: Structured logging + distributed tracing.
- **Performant**: Redis caching for fast URL resolution.
- **Tested**: Unit + Integration tests with coverage targets.

## Minimal project Structure

```
- Features/                             // Features
  - Shortify/
    - ShortifyRequest.cs                // Request
    - ShortifyEndpoint.cs               // Endpoint definition (POST /api/shortify)
    - ShortifyResponse.cs               // Response
  - Unshortify/
    - GetShortRequest.cs                // Request
    - GetShortEndpoint.cs               // Endpoint definition (GET /api/un-shortify/{shortUrl})
    - GetShortResponse.cs               // Response
- Infrastructure/
  - Persistence/                        // Database
    - Migrations/
      - InitialMigration.cs
      - ...
    - ShortifyDbContext.cs
- Shared/
  - Models/                               // Domain entities
    - ShortUrl.cs
```

## API Endpoints

### POST `/api/shortify`

**Description:**  
Creates an abbreviated version of a provided URL. Generates a unique short code, persists to database, and inserts into cache for future resolutions.

**Request Body:**
```json
{
  "originalUrl": "https://www.example-very-long-website.com/path/to/page?param1=value1&param2=value2"
}
```

**Response (201 Created):**
```json
{
  "shortCode": "aBc1Xy",
  "shortUrl": "https://yourserver.com/r/aBc1Xy"
}
```

### GET `/api/un-shortify/{shortUrl}`

**Description:**  
Resolves a short code returning the original URL. Implements Cache-Aside pattern: checks cache first, on miss queries DB, repopulates cache, and returns result.

**Query string Parameter:**
- `shortCode` (string, required): The abbreviated code generated by `/api/shortify`.

**Response (200 OK):**
```json
{
  "originalUrl": "https://www.example-very-long-website.com/path/to/page?param1=value1&param2=value2"
}
```

## Domain Model

### ShortUrl Entity (Domain/ShortUrl.cs)

```csharp
public class ShortUrl
{
    public int Id { get; set; }
    
    [Required]
    [StringLength(10)]
    public string ShortCode { get; set; }
    
    [Required]
    public string OriginalUrl { get; set; }
    
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
}
```

## Docker Development

ShortiFy can be run in Docker containers along with all required infrastructure services.

### Prerequisites

- [Docker](https://docs.docker.com/get-docker/) (v20.10+)
- [Docker Compose](https://docs.docker.com/compose/install/) (v2.0+)

### Quick Start

1. **Copy environment file:**
  ```bash
  cp .env.example .env
  ```

2. **Start all services:**
  ```bash
  docker compose up -d
  ```

3. **Verify services are running:**
  ```bash
  docker compose ps
  ```

4. **Access the application:**
  - **API:** http://localhost:5080
  - **Health Check:** http://localhost:5080/health
  - **Aspire Dashboard:** http://localhost:18888

### Services

| Service | Port | Description |
|---------|------|-------------|
| `shortify-api` | 5080 | ShortiFy API |
| `sqlserver` | 1433 | SQL Server 2022 |
| `redis` | 6379 | Redis 7 Cache |
| `aspire-dashboard` | 18888 | OpenTelemetry Dashboard |

### Common Commands

```bash
# Start infrastructure only (SQL Server, Redis, Aspire Dashboard)
docker compose up -d sqlserver redis aspire-dashboard

# Start all services
docker compose up -d

# View logs
docker compose logs -f shortify-api

# Stop all services (preserve data)
docker compose down

# Stop all services and remove volumes (clean slate)
docker compose down -v

# Rebuild API after code changes
docker compose up -d --build shortify-api
```

### Connecting to SQL Server

Use your preferred SQL client with these connection details:

| Property | Value |
|----------|-------|
| Server | `localhost,1433` |
| Database | `ShortiFy` |
| Username | `sa` |
| Password | `YourStrong!Passw0rd` (or value from `.env`) |

**Connection String:**
```
Server=localhost,1433;Database=ShortiFy;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True
```

### Viewing Telemetry

1. Open the Aspire Dashboard at http://localhost:18888
2. Navigate to **Traces** to see distributed traces
3. Navigate to **Metrics** to see application metrics
4. Navigate to **Logs** to see structured logs

### Troubleshooting

**API fails to start with database connection error:**
```bash
# Ensure SQL Server is healthy
docker compose ps sqlserver
# Wait for SQL Server to be ready (can take 30+ seconds on first start)
docker compose logs sqlserver
```

**Reset everything and start fresh:**
```bash
docker compose down -v
docker compose up -d
```

**View real-time logs:**
```bash
docker compose logs -f
```
